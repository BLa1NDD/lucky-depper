import streamlit as st, json, time, random, os



st.set_page_config(
    page_title="Lucky Depper",
    page_icon="üé∞",
    layout="wide",
    initial_sidebar_state="expanded"
)

# –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —Å–∞–π–¥–±–∞—Ä
st.markdown("""
<style>
    [data-testid="stSidebar"] {
        display: block !important;
        visibility: visible !important;
    }
    .css-1d391kg {
        display: block !important;
    }
    
    /* CSS –¥–ª—è –∞–Ω–∏–º–∞—Ü–∏–∏ –≥–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª—å–Ω–æ–π —Å–ø–∏—Ä–∞–ª–∏ */
    @keyframes wave {
        0%, 100% { transform: translateY(0px); }
        25% { transform: translateY(-5px); }
        75% { transform: translateY(5px); }
    }
    
    .horizontal-spiral {
        display: inline-block;
        width: 30px;
        height: 8px;
        margin-left: 10px;
        position: relative;
    }
    
    .spiral-dot {
        width: 6px;
        height: 6px;
        background: #3498db;
        border-radius: 50%;
        position: absolute;
        animation: wave 1.5s ease-in-out infinite;
    }
    
    .spiral-dot:nth-child(1) { left: 0px; animation-delay: 0s; }
    .spiral-dot:nth-child(2) { left: 8px; animation-delay: 0.1s; }
    .spiral-dot:nth-child(3) { left: 16px; animation-delay: 0.2s; }
    .spiral-dot:nth-child(4) { left: 24px; animation-delay: 0.3s; }
    
    /* CSS –¥–ª—è –∞–Ω–∏–º–∞—Ü–∏–∏ –≤—Ä–∞—â–∞—é—â–µ–≥–æ—Å—è –∫–æ–ª–µ—Å–∞ */
    @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }
    
    .spinning-wheel {
        display: inline-block;
        width: 150px;
        height: 150px;
        border: 18px solid #e0e0e0;
        border-top: 18px solid #ff6b6b;
        border-right: 18px solid #4ecdc4;
        border-bottom: 18px solid #45b7d1;
        border-left: 18px solid #96ceb4;
        border-radius: 50%;
        margin: 15px auto;
        box-shadow: 0 8px 16px rgba(0,0,0,0.2);
    }
</style>
""", unsafe_allow_html=True)

# –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Å–µ—Å—Å–∏–∏ —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –µ—ë –Ω–µ—Ç


if "show_toast_until" not in st.session_state:
    st.session_state.show_toast_until = 0
if "last_toast_message" not in st.session_state:
    st.session_state.last_toast_message = ""
if "last_toast_icon" not in st.session_state:
    st.session_state.last_toast_icon = ""
if "show_register" not in st.session_state:
    st.session_state.show_register = False
if "show_spinning_animation" not in st.session_state:
    st.session_state.show_spinning_animation = False




def main_game():
    global data, user_index, stavka
    st.title("üé∞ Lucky Depper")

    # –°–æ–∑–¥–∞–µ–º —Å–∞–π–¥–±–∞—Ä
    st.sidebar.title("üé∞ Lucky Depper")
    st.sidebar.header("–ü—Ä–æ—Ñ–∏–ª—å")

    # –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ
    if user_index is not None and data["users"][user_index].get("last_login", False) == True:
        st.sidebar.write(f"üë§ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å: {data['users'][user_index]['login']}")
        st.sidebar.write(f"üí∞ –ë–∞–ª–∞–Ω—Å: {float(data['users'][user_index]['balance'])}")

    # –ö–Ω–æ–ø–∫–∞ –≤—ã—Ö–æ–¥–∞ –∏–∑ –∞–∫–∫–∞—É–Ω—Ç–∞
    if st.sidebar.button("üö™ –í—ã–π—Ç–∏ –∏–∑ –∞–∫–∫–∞—É–Ω—Ç–∞", type="primary"):
        if user_index is not None and data["users"][user_index].get("last_login", False) == True:
            for user in data["users"]:
                if user["login"] == data["users"][user_index]["login"]:
                    user["last_login"] = False
                    break
            
            with open("data.json", "w", encoding="utf-8") as f:
                json.dump(data, f, ensure_ascii=False, indent=2)
        
        st.rerun()

    # –†–∞–∑–¥–µ–ª–∏—Ç–µ–ª—å
    st.sidebar.divider()

    # –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏
    st.sidebar.subheader("–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞")
    st.sidebar.write("üéØ –í–µ—Ä–æ—è—Ç–Ω–æ—Å—Ç–∏ –≤—ã–∏–≥—Ä—ã—à–∞:")
    st.sidebar.write("‚Ä¢ 1 - 1.5x = 40%")
    st.sidebar.write("‚Ä¢ 5 - 2x = 20%") 
    st.sidebar.write("‚Ä¢ 10 - 2.5x = 10%")
    st.sidebar.write("‚Ä¢ –ö - 3x = 5%")
    st.sidebar.write("‚Ä¢ –ó - 5x = 1%")

    options = ["1", "5", "10", "–ö", "–ó"]

    user_dep = st.selectbox("–í–∞—à–∞ —Å—Ç–∞–≤–∫–∞ ", options)
    num_dep = st.number_input("–†–∞–∑–º–µ—Ä –¥–µ–ø–∞ ", step=0.1)

    now = time.time()

    if st.session_state.show_toast_until > now:
        st.toast(st.session_state.last_toast_message, icon=st.session_state.last_toast_icon)
        st.toast("–ù–∞–¥–æ —á—Ç–æ-—Ç–æ –¥–µ–ø–Ω—É—Ç—å —Å–∫–æ—Ä–µ–µ!", icon="üí∞")
        



    if user_index is not None:
        if num_dep > data["users"][user_index]["balance"]:
            st.toast("–£ —Ç–µ–±—è –Ω–µ—Ç –¥–µ–Ω–µ–≥ –Ω–∞ –î–ï–ü ", icon="‚ùå")
        else:
            if st.button("–î–ï–ü–ù–£–¢–¨"):
                # –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∞–Ω–∏–º–∞—Ü–∏—é –≤—Ä–∞—â–µ–Ω–∏—è
                st.session_state.show_spinning_animation = True
                st.rerun()
            
            # –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –≤—Ä–∞—â–∞—é—â–µ–µ—Å—è –∫–æ–ª–µ—Å–æ –ø–æ—Å–ª–µ –Ω–∞–∂–∞—Ç–∏—è –∫–Ω–æ–ø–∫–∏
            if st.session_state.show_spinning_animation:
                # –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º —Å–ª—É—á–∞–π–Ω–æ–µ –≤—Ä–µ–º—è –≤—Ä–∞—â–µ–Ω–∏—è –æ—Ç 3 –¥–æ 6 —Å–µ–∫—É–Ω–¥
                spin_time = random.uniform(3, 6)
                
                st.markdown(f"""
                <div style="text-align: center; margin-top: 10px;">
                    <div class="spinning-wheel" style="animation: spin {spin_time}s linear infinite;"></div>
                    <p style="color: #666; margin-top: 15px; font-size: 16px;">üé∞ –ö—Ä—É—Ç–∏–º –∫–æ–ª–µ—Å–æ —É–¥–∞—á–∏...</p>
                </div>
                """, unsafe_allow_html=True)
                
                # –ò–º–∏—Ç–∏—Ä—É–µ–º –æ–±—Ä–∞–±–æ—Ç–∫—É - –∏—Å–ø–æ–ª—å–∑—É–µ–º —Ç–æ –∂–µ —Å–ª—É—á–∞–π–Ω–æ–µ –≤—Ä–µ–º—è
                time.sleep(spin_time)
                
                # –í—ã–ø–æ–ª–Ω—è–µ–º –ª–æ–≥–∏–∫—É –∏–≥—Ä—ã
                dep_ran = random.randint(1 + random.randint(5, 30), 95)
                print(dep_ran)
                user_dep_chance = stavka[user_dep][1]
                if dep_ran + user_dep_chance >= 100:
                    data["users"][user_index]["balance"] += num_dep * (stavka[user_dep][0]) 
                    st.session_state.last_toast_message = f"–ü–æ–∑–¥—Ä–∞–≤–ª—è–µ–º! –í–∞—à –±–∞–ª–∞–Ω—Å: {data['users'][user_index]['balance']} –¥–µ–ø –∫–æ–∏–Ω–æ–≤"
                    st.session_state.last_toast_icon = "‚úÖ"
                    with open("data.json", "w", encoding="utf-8") as f:
                        json.dump(data, f, ensure_ascii=False, indent=2)
                else:
                    data["users"][user_index]["balance"] -= num_dep
                    st.session_state.last_toast_message = f"–î–µ–ª–∞–π –î–û–î–ï–ü —Ç—ã –ø—Ä–æ–∏–≥—Ä–∞–ª :( –í–∞—à –±–∞–ª–∞–Ω—Å: {data['users'][user_index]['balance']} –¥–µ–ø –∫–æ–∏–Ω–æ–≤"
                    st.session_state.last_toast_icon = "‚ùå"
                    with open("data.json", "w", encoding="utf-8") as f:
                        json.dump(data, f, ensure_ascii=False, indent=2)
                
                st.session_state.show_toast_until = time.time() + 2
                st.session_state.show_spinning_animation = False
                st.rerun()






def registr():
    # –ó–∞–≥–æ–ª–æ–≤–æ–∫ —Å –≥–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª—å–Ω–æ–π —Å–ø–∏—Ä–∞–ª—å—é
    st.markdown("""
    <div style="display: flex; align-items: center; justify-content: center;">
        <h1 style="margin: 0;">register please</h1>
        <div class="horizontal-spiral">
            <div class="spiral-dot"></div>
            <div class="spiral-dot"></div>
            <div class="spiral-dot"></div>
            <div class="spiral-dot"></div>
        </div>
    </div>
    """, unsafe_allow_html=True)
    
    
    input_user_name = st.text_input("üë§ login", placeholder="–í–≤–µ–¥–∏—Ç–µ login", max_chars=18)
    input_password = st.text_input("üîí password", type="password", placeholder="–í–≤–µ–¥–∏—Ç–µ password", max_chars=30)
    input_password_confirm = st.text_input("üîí password confirm", type="password", placeholder="–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç–µ –ø–∞—Ä–æ–ª—å", max_chars=30)
    if st.button("–ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å—Å—è"):  
        if not input_user_name or not input_password:
            st.toast("–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –ø–æ–ª—è!", icon="‚ùå")
        elif input_password != input_password_confirm:
            st.toast("–ü–∞—Ä–æ–ª–∏ –æ—Ç–ª–∏—á–∞—é—Ç—Å—è!", icon="‚ùå") 
        elif len(input_user_name) < 3 or len(input_password) < 3:
            st.toast("–õ–æ–≥–∏–Ω –∏ –ø–∞—Ä–æ–ª—å –¥–æ–ª–∂–Ω—ã –Ω–µ –º–µ–Ω–µ–µ 3 —Å–∏–º–≤–æ–ª–æ–≤!", icon="‚ùå")
        
        else:
            with open('data.json', 'r', encoding='utf-8') as file:
                data = json.load(file)
            if data["users"]:
                copy_user = any(user["login"] == input_user_name for user in data["users"])
                if copy_user:
                    st.toast("–¢–∞–∫–æ–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç!", icon="‚ùå")  
                else:
                    data["users"].append({
                        "login": input_user_name,
                        "password": input_password,
                        "balance": 1000.0,
                        "last_login": False
                    })  
                    with open("data.json", "w", encoding="utf-8") as f:
                        json.dump(data, f, ensure_ascii=False, indent=2)
                    st.toast(f"–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å {input_user_name} —É—Å–ø–µ—à–Ω–æ –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω!", icon="‚úÖ")
                    print(st.session_state.show_register)
                    time.sleep(3)
                    st.session_state.show_register = False
                    st.rerun()
                    
            else:
                data["users"].append({
                        "login": input_user_name,
                        "password": input_password,
                        "balance": 1000.0,
                        "last_login": False
                    })  
                with open("data.json", "w", encoding="utf-8") as f:
                    json.dump(data, f, ensure_ascii=False, indent=2)
                st.toast(f"–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å {input_user_name} —É—Å–ø–µ—à–Ω–æ –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω!", icon="‚úÖ")
                print(st.session_state.show_register)
                time.sleep(3)
                st.session_state.show_register = False
                st.rerun()
                
            



    if st.button("üîÑ –ù–∞–∑–∞–¥"):
        st.session_state.show_register = False
        st.rerun()






def login():
    
    st.markdown("""
    <style>
        @keyframes wave {
            0%, 100% { transform: translateY(0px); }
            25% { transform: translateY(-5px); }
            75% { transform: translateY(5px); }
        }
        
        .horizontal-spiral {
            display: inline-block;
            width: 30px;
            height: 8px;
            margin-left: 10px;
            position: relative;
        }
        
        .spiral-dot {
            width: 6px;
            height: 6px;
            background: #3498db;
            border-radius: 50%;
            position: absolute;
            animation: wave 1.5s ease-in-out infinite;
        }
        
        .spiral-dot:nth-child(1) { left: 0px; animation-delay: 0s; }
        .spiral-dot:nth-child(2) { left: 8px; animation-delay: 0.1s; }
        .spiral-dot:nth-child(3) { left: 16px; animation-delay: 0.2s; }
        .spiral-dot:nth-child(4) { left: 24px; animation-delay: 0.3s; }
    </style>
    """, unsafe_allow_html=True)
    
    # –ó–∞–≥–æ–ª–æ–≤–æ–∫ —Å –≥–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª—å–Ω–æ–π —Å–ø–∏—Ä–∞–ª—å—é
    st.markdown("""
    <div style="display: flex; align-items: center; justify-content: center;">
        <h1 style="margin: 0;">Hello</h1>
        <div class="horizontal-spiral">
            <div class="spiral-dot"></div>
            <div class="spiral-dot"></div>
            <div class="spiral-dot"></div>
            <div class="spiral-dot"></div>
        </div>
    </div>
    """, unsafe_allow_html=True)
    
    st.title("login please")
    input_user_name = st.text_input("üë§ login", placeholder="–í–≤–µ–¥–∏—Ç–µ –ª–æ–≥–∏–Ω", max_chars=18)
    input_password = st.text_input("üîí password", type="password", placeholder="–í–≤–µ–¥–∏—Ç–µ –ø–∞—Ä–æ–ª—å", max_chars=30)
    if st.button("–í–æ–π—Ç–∏"):     
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º –≤—Å–µ—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
        user_found = False
        for user in data["users"]:
            if user["login"] == input_user_name and user["password"] == input_password:
                user["last_login"] = True        
                with open("data.json", "w", encoding="utf-8") as f:
                    json.dump(data, f, ensure_ascii=False, indent=2)
                st.toast(f'–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å, {input_user_name}!', icon="‚úÖ")
                user_found = True
                time.sleep(1)
                st.rerun()
                 
                
        
        # –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –æ—à–∏–±–∫—É —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –Ω–∞–π–¥–µ–Ω
        if not user_found:
            st.toast("–ù–µ–≤–µ—Ä–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è!  –í–æ–∑–º–æ–∂–Ω–æ —Å—Ç–æ–∏—Ç –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∏—Ç—å —Å—Ç—Ä–∞–Ω–∏—Ü—É –∏–ª–∏ –∫–ª–∏–∫–Ω—É—Ç—å –ø–æ –æ–¥–Ω–æ–π –∏–∑ —Å—Ç—Ä–æ–∫ –≤–≤–æ–¥–∞ –¥–∞–Ω–Ω—ã—Ö!", icon="‚ùå")

    
    st.markdown("---")
    
    
    st.markdown("""
    <div style="text-align: center; margin-top: 20px; padding: 15px; background-color: #242434; border-radius: 8px;">
        <p style="color: #666; font-size: 14px; margin-bottom: 8px;">–ù–µ—Ç –∞–∫–∫–∞—É–Ω—Ç–∞?</p>
        <p style="color: #1f77b4; font-size: 16px; font-weight: bold; margin: 0;">
           üìù –ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä—É–π—Å—è
        </p>
    </div>
    """, unsafe_allow_html=True)
    
    # –ö–Ω–æ–ø–∫–∞ –ø—Ä—è–º–æ –ø–æ–¥ —Ç–µ–∫—Å—Ç–æ–º
    col1, col2, col3 = st.columns([2.1, 1, 1.5])
    with col2:
        if st.button("üìù –ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å—Å—è", key="register_btn", help="–°–æ–∑–¥–∞—Ç—å –Ω–æ–≤—ã–π –∞–∫–∫–∞—É–Ω—Ç"):
            st.session_state.show_register = True
            st.rerun()
    
    




data = {
    "users": [        
    ] 
}


if not os.path.exists("data.json"):
    with open("data.json", "w", encoding="utf-8") as f:
        json.dump(data, f, ensure_ascii=False, indent=2)



with open("data.json", "r", encoding="utf-8") as f:
       data = json.load(f)







if "users" not in data:
    st.error("–§–∞–π–ª data.json –ø–æ–≤—Ä–µ–∂–¥—ë–Ω –∏–ª–∏ –Ω–µ —Å–æ–¥–µ—Ä–∂–∏—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π!")
    st.stop()


for user in data["users"]:
    if "last_login" not in user:
        user["last_login"] = False
    if "balance" not in user:
        user["balance"] = 0.0



user_index = None

for i, user in enumerate(data["users"]):
    if user.get("last_login", False) == True:
        user_index = i
        break

stavka = {
    "1": [1.5, 40],#–ª–∏—Å—Ç –∏–∑ 1: x , 2: –ø—Ä–æ—Ü–µ–Ω—Ç
    "5": [2, 20],
    "10": [2.5, 10],
    "–ö": [3, 5],
    "–ó": [5, 1]
}







if user_index == None or data["users"][user_index].get("last_login", False) == False:
    if  st.session_state.show_register:
        registr()
    elif user_index == None or data["users"][user_index].get("last_login", False) == False:
        login()
else:
    main_game()

        
    





